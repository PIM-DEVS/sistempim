<div class="profile-page">

  <ng-container *ngIf="dadosUsuario && !loading; else loadingTemplate">
    
    <div class="profile-banner" [style.background-image]="dadosUsuario.banner ? 'url(' + dadosUsuario.banner + ')' : 'none'">
      <div class="overlay" *ngIf="dadosUsuario.banner"></div>
    </div>

    <div class="layout-grid">
      
      <aside class="left-col">
        
        <div class="card profile-card">
          <div class="avatar-container">
            <img 
              [src]="(isEditing && editForm.foto ? editForm.foto : dadosUsuario?.foto) || 'assets/images/masculino.jpg'" 
              class="avatar-img"
              onerror="this.src='assets/images/masculino.jpg'"
            >
          </div>

          <div class="user-info">
            <h2>{{ dadosUsuario.nome }} <i class="bx bxs-badge-check verified"></i></h2>
            <p class="role">{{ dadosUsuario.cargo || 'Membro do PIM' }}</p>
          </div>

          <div class="stats-row">
            <div class="stat"><strong>{{ dadosUsuario.seguidores?.length || 0 }}</strong><span>Seguidores</span></div>
            <div class="stat"><strong>{{ dadosUsuario.seguindo?.length || 0 }}</strong><span>Seguindo</span></div>
            <div class="stat"><strong>{{ dadosUsuario.posts || 0 }}</strong><span>Posts</span></div>
          </div>

          <div class="actions">
            <button *ngIf="isMeuPerfil" class="btn-primary" (click)="toggleEdit()" [ngClass]="{'btn-cancel': isEditing}">
              {{ isEditing ? 'Cancelar' : 'Editar Perfil' }}
            </button>
            
            <div *ngIf="!isMeuPerfil" class="dual-btns">
               <button class="btn-primary" [class.outline]="isFollowing" (click)="toggleFollow()">
                 {{ isFollowing ? 'Seguindo' : 'Seguir' }}
               </button>
               <button *ngIf="isFollowing" class="btn-icon" (click)="irParaChat()">
                 <i class='bx bx-message-rounded-dots'></i>
               </button>
            </div>
          </div>
        </div>

        <div class="card mt-20">
          <div class="card-header-simple">
            <h3><i class='bx bx-star'></i> Competências</h3>
          </div>

          <div class="add-skill-box" *ngIf="isEditing">
             <input [(ngModel)]="novaCompetencia" (keyup.enter)="adicionarCompetencia()" placeholder="Ex: Liderança, Design...">
             <button (click)="adicionarCompetencia()"><i class='bx bx-plus'></i></button>
          </div>

          <div class="skills-container">
            <span class="skill-pill" *ngFor="let skill of isEditing ? editForm.competencias : dadosUsuario.competencias; let i = index">
              {{ skill }}
              <i *ngIf="isEditing" class='bx bx-x' (click)="removerCompetencia(i)"></i>
            </span>
            <p *ngIf="!dadosUsuario.competencias?.length && !isEditing" class="empty-text">Nenhuma competência registrada.</p>
          </div>
        </div>

      </aside>

      <main class="right-col">
        
        <div class="card">
          <div class="card-header">
            <h3>{{ isEditing ? 'Editando Perfil' : 'Sobre Mim' }}</h3>
          </div>
          
          <div class="card-body">
            <p *ngIf="!isEditing" class="bio-text">{{ dadosUsuario.bio || 'Este usuário ainda não adicionou uma biografia.' }}</p>

            <div *ngIf="isEditing" class="edit-form">
               <div class="form-group">
                 <label>Foto de Perfil (URL)</label>
                 <input [(ngModel)]="editForm.foto" placeholder="https://...">
               </div>
               <div class="row-group">
                 <div class="form-group"><label>Nome</label><input [(ngModel)]="editForm.nome"></div>
                 <div class="form-group"><label>Cargo</label><input [(ngModel)]="editForm.cargo"></div>
               </div>
               <div class="form-group">
                 <label>Biografia</label>
                 <textarea [(ngModel)]="editForm.bio" rows="5"></textarea>
               </div>
               <button class="btn-save" (click)="salvarPerfil()">Salvar Alterações</button>
            </div>
          </div>
        </div>

        <div class="card mt-20" *ngIf="!isEditing">
           <div class="card-header"><h3>Detalhes</h3></div>
           <div class="info-list">
              <div class="info-item">
                <i class='bx bx-envelope'></i>
                <div><small>Email</small><p>{{ dadosUsuario.email }}</p></div>
              </div>
              <div class="info-item">
                <i class='bx bx-calendar'></i>
                <div><small>Entrou em</small><p>{{ getMemberSince(dadosUsuario.createdAt) }}</p></div>
              </div>
           </div>
        </div>

      </main>
    </div>
  </ng-container>


  <ng-template #loadingTemplate>
    
    <div class="profile-banner sk-bg animate-pulse"></div>

    <div class="layout-grid">
      
      <aside class="left-col">
        <div class="card profile-card">
          <div class="avatar-container">
            <div class="sk-avatar animate-pulse"></div>
          </div>

          <div class="user-info sk-center">
            <div class="sk-line title animate-pulse"></div>
            <div class="sk-line subtitle animate-pulse"></div>
          </div>

          <div class="stats-row">
             <div class="sk-box animate-pulse"></div>
             <div class="sk-box animate-pulse"></div>
             <div class="sk-box animate-pulse"></div>
          </div>

          <div class="actions">
             <div class="sk-btn animate-pulse"></div>
          </div>
        </div>

        <div class="card mt-20">
           <div class="card-header-simple mb-3">
             <div class="sk-line title-sm animate-pulse"></div>
           </div>
           <div class="skills-container">
             <div class="sk-pill animate-pulse"></div>
             <div class="sk-pill animate-pulse"></div>
             <div class="sk-pill animate-pulse"></div>
             <div class="sk-pill animate-pulse"></div>
           </div>
        </div>
      </aside>

      <main class="right-col">
         <div class="card">
            <div class="card-header"><div class="sk-line title-sm animate-pulse"></div></div>
            <div class="card-body">
               <div class="sk-line full animate-pulse"></div>
               <div class="sk-line full animate-pulse"></div>
               <div class="sk-line full animate-pulse"></div>
               <div class="sk-line half animate-pulse"></div>
            </div>
         </div>

         <div class="card mt-20">
            <div class="card-header"><div class="sk-line title-sm animate-pulse"></div></div>
            <div class="info-list">
               <div class="sk-input animate-pulse mb-3"></div>
               <div class="sk-input animate-pulse"></div>
            </div>
         </div>
      </main>

    </div>
  </ng-template>

</div>